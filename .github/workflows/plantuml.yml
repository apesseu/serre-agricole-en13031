name: PlantUML Diagram Generation

on:
  push:
    branches:
      - test-plantuml

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11
          
      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          
      - name: Download PlantUML
        run: |
          curl -L -o plantuml.jar "https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar"
          if [ ! -f plantuml.jar ] || [ ! -s plantuml.jar ]; then
            echo "‚ùå √âchec du t√©l√©chargement de PlantUML"
            exit 1
          fi
          echo "‚úÖ PlantUML t√©l√©charg√© : $(ls -lh plantuml.jar)"
          
      - name: Verify PlantUML installation
        run: java -jar plantuml.jar -version
          
      - name: Check PlantUML source files
        run: |
          echo "Recherche des fichiers .puml dans diagrams/ ..."
          find diagrams -name "*.puml" -type f || echo "‚ö†Ô∏è Aucun fichier .puml trouv√© dans diagrams/"
          
      - name: Generate SVG diagrams in docs/
        shell: bash
        run: |
          mkdir -p docs
          puml_files=$(find diagrams -name "*.puml" -type f | wc -l)
          if [ "$puml_files" -eq 0 ]; then
            echo "‚ùå Aucun fichier .puml trouv√© dans diagrams/, impossible de g√©n√©rer les diagrammes"
            exit 1
          fi
          
          echo "üìä G√©n√©ration des diagrammes PlantUML en SVG vers docs/ ..."
          java -jar plantuml.jar -tsvg -o docs diagrams/*.puml
          exit_code=$?
          
          if [ $exit_code -ne 0 ]; then
            echo "‚ùå Erreur lors de la g√©n√©ration des diagrammes (code $exit_code)"
            exit $exit_code
          fi
          
          echo "‚úÖ G√©n√©ration termin√©e."
          
          echo "üìÇ Contenu du dossier docs/ apr√®s g√©n√©ration :"
          ls -la docs/ || echo "‚ö†Ô∏è Le dossier docs/ est vide"
          
          echo "üîç Recherche d√©taill√©e des fichiers SVG g√©n√©r√©s (r√©cursif):"
          find docs -name "*.svg" -print || echo "‚ö†Ô∏è Aucun fichier SVG trouv√© dans docs/"
          
      - name: Summary of generated SVG files
        run: |
          svg_count=$(find docs -name "*.svg" | wc -l)
          echo "üìà Nombre total de fichiers SVG g√©n√©r√©s dans docs/ : $svg_count"
          
          if [ "$svg_count" -eq 0 ]; then
            echo "‚ùå Aucun fichier SVG g√©n√©r√©, v√©rifier la g√©n√©ration."
            exit 1
          else
            echo "‚úÖ Fichiers SVG g√©n√©r√©s avec succ√®s."
          fi
          
      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          publish_branch: gh-pages

name: PlantUML Diagram Generation

on:
  push:
    branches:
      - test-plantuml
      - main

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11
          
      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz
          
      - name: Download PlantUML
        run: |
          curl -L -o plantuml.jar "https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar"
          if [ ! -f plantuml.jar ] || [ ! -s plantuml.jar ]; then
            echo "‚ùå √âchec du t√©l√©chargement de PlantUML"
            exit 1
          fi
          echo "‚úÖ PlantUML t√©l√©charg√© : $(ls -lh plantuml.jar)"
          
      - name: Verify PlantUML installation
        run: java -jar plantuml.jar -version
          
      - name: Check PlantUML files
        run: |
          echo "Fichiers .puml trouv√©s :"
          find diagrams -name "*.puml" -type f || echo "Aucun fichier .puml trouv√©"
          
      - name: Generate SVG diagrams
        shell: bash
        run: |
          set +e
          mkdir -p docs
          puml_files=$(find diagrams -name "*.puml" -type f | wc -l)
          if [ "$puml_files" -eq 0 ]; then
            echo "‚ùå Aucun fichier .puml trouv√© dans diagrams/"
            exit 1
          fi
          echo "üìä G√©n√©ration des diagrammes..."
          success_count=0
          error_count=0
          cd docs
          for file in ../diagrams/*.puml; do
            if [ -f "$file" ]; then
              echo "üîÑ G√©n√©ration de : $file"
              java -jar ../plantuml.jar -tsvg -v "$file" 2>&1
              exit_code=$?
              if [ $exit_code -eq 0 ]; then
                echo "‚úÖ Succ√®s : $file"
                success_count=$((success_count + 1))
              else
                echo "‚ùå Erreur lors de la g√©n√©ration de : $file (code : $exit_code)"
                error_count=$((error_count + 1))
              fi
            fi
          done
          cd ..
          echo "üìà R√©sultats : $success_count succ√®s, $error_count erreurs"
          if [ $success_count -gt 0 ]; then
            echo "‚úÖ Au moins un diagramme g√©n√©r√© avec succ√®s"
            exit 0
          else
            echo "‚ùå Aucun diagramme g√©n√©r√©"
            exit 1
          fi

      - name: List generated files
        run: |
          echo "Fichiers g√©n√©r√©s dans docs/:"
          ls -la docs/ || echo "Le dossier docs/ est vide"
          svg_count=$(find docs -name "*.svg" | wc -l)
          echo "Nombre de fichiers SVG : $svg_count"

      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          publish_branch: gh-pages

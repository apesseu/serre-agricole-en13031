name: PlantUML Diagram Generation & Deploy

on:
  push:
    branches:
      - test-plantuml

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout du d√©p√¥t
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Installer Java et Graphviz
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      # 3. T√©l√©charger PlantUML
      - name: Download PlantUML
        run: |
          curl -L -o plantuml.jar "https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar"
          if [ ! -s plantuml.jar ]; then
            echo "‚ùå PlantUML n‚Äôa pas √©t√© t√©l√©charg√© !"
            exit 1
          fi
          echo "‚úÖ PlantUML t√©l√©charg√© : $(ls -lh plantuml.jar)"

      # 4. V√©rifier les fichiers .puml trouv√©s
      - name: Check for PUML files
        run: |
          echo "üîç Recherche des fichiers .puml dans diagrams/"
          find diagrams -name "*.puml" -type f || echo "‚ö†Ô∏è Aucun fichier .puml trouv√©"

      # 5. G√©n√©ration des SVG
      - name: Generate SVGs
        run: |
          mkdir -p docs
          echo "üìä G√©n√©ration des diagrammes..."
          java -jar plantuml.jar -tsvg -v diagrams/*.puml
          
          echo "üìÇ Contenu apr√®s g√©n√©ration :"
          find diagrams -name "*.svg"

          echo "üì¶ Copie dans docs/"
          cp diagrams/*.svg docs/ || echo "‚ö†Ô∏è Aucun SVG √† copier"

          echo "üìÇ Contenu final de docs/"
          ls -la docs/

      # 6. Cr√©er un index.html pour lister les SVG
      - name: Generate index.html
        run: |
          echo "<html><head><title>PlantUML Diagrams</title></head><body>" > docs/index.html
          echo "<h1>Liste des diagrammes g√©n√©r√©s</h1><ul>" >> docs/index.html
          for f in docs/*.svg; do
            fname=$(basename "$f")
            echo "<li><a href=\"$fname\">$fname</a></li>" >> docs/index.html
          done
          echo "</ul></body></html>" >> docs/index.html

          echo "‚úÖ index.html cr√©√© dans docs/"

      # 7. D√©ployer sur GitHub Pages (branche gh-pages)
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          publish_branch: gh-pages

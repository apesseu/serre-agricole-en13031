name: PlantUML Ultra Debug

on:
  push:
    branches:
      - test-plantuml
      - main

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Checkout repository
        uses: actions/checkout@v4

      - name: âœ… Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: âœ… Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: âœ… Download PlantUML
        run: |
          echo "ğŸ“¥ TÃ©lÃ©chargement de PlantUML..."
          curl -L -o plantuml.jar "https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar"
          ls -lh plantuml.jar || echo "âŒ plantuml.jar n'a pas Ã©tÃ© tÃ©lÃ©chargÃ© correctement !"
          file plantuml.jar || echo "âŒ Impossible de lire plantuml.jar !"

      - name: âœ… Verify PlantUML installation
        run: |
          echo "ğŸ” VÃ©rification version PlantUML..."
          java -jar plantuml.jar -version || echo "âŒ PlantUML ne se lance pas !"

      - name: âœ… Debug - Lister tous les fichiers du repo
        run: |
          echo "ğŸ“‚ Structure du repo aprÃ¨s checkout :"
          ls -R . | head -n 300
          echo "--- Fin de la liste ---"

      - name: âœ… Debug - Trouver les fichiers .puml
        run: |
          echo "ğŸ” Recherche des fichiers .puml dans tout le repo..."
          find . -type f -name "*.puml" -print || echo "âŒ Aucun .puml trouvÃ©"
          echo "--- Fin de la recherche ---"

      - name: âœ… VÃ©rifier contenu des fichiers .puml
        run: |
          echo "ğŸ“– AperÃ§u du contenu des .puml :"
          for f in $(find . -name "*.puml"); do
            echo "----- $f -----"
            head -n 20 "$f"
          done || echo "âŒ Aucun fichier .puml Ã  lire"

      - name: âœ… GÃ©nÃ©ration PlantUML en mode ultra-verbose
        run: |
          mkdir -p docs
          echo "ğŸ“Š Lancement gÃ©nÃ©ration PlantUML en mode DEBUG VERBEUX..."

          # Log du chemin de travail
          echo "ğŸ“Œ Chemin courant: $(pwd)"
          echo "ğŸ“‚ Contenu avant gÃ©nÃ©ration:"
          ls -R . | head -n 200

          # GÃ©nÃ©ration ultra-verbose
          java -jar plantuml.jar -v -tsvg diagrams/*.puml || echo "âš ï¸ PlantUML a retournÃ© une erreur"

          echo "âœ… Fin gÃ©nÃ©ration"

          echo "ğŸ“‚ Contenu aprÃ¨s gÃ©nÃ©ration:"
          ls -R . | head -n 200

      - name: âœ… Recherche globale des SVG gÃ©nÃ©rÃ©s
        run: |
          echo "ğŸ” Recherche globale des fichiers SVG aprÃ¨s gÃ©nÃ©ration..."
          find . -name "*.svg" -print || echo "âŒ Aucun SVG trouvÃ© nulle part"
          echo "--- Fin recherche SVG ---"

      - name: âœ… Copier tous les SVG trouvÃ©s vers docs/
        run: |
          echo "ğŸ“¦ Copie automatique des SVG vers docs/ (sâ€™ils existent)"
          find . -name "*.svg" -exec cp {} docs/ \; || true
          echo "ğŸ“‚ Contenu de docs/ aprÃ¨s tentative de copie:"
          ls -la docs/ || echo "âš ï¸ Toujours rien dans docs/"

      - name: âœ… Check rÃ©sultat final
        run: |
          svg_count=$(find docs -name "*.svg" | wc -l)
          echo "ğŸ“ˆ Nombre total de SVG dans docs/ : $svg_count"
          if [ "$svg_count" -eq 0 ]; then
            echo "âš ï¸ Aucun SVG gÃ©nÃ©rÃ© â†’ On va crÃ©er un fichier .puml minimal pour tester"
            echo "@startuml" > test.puml
            echo "Alice -> Bob: Hello" >> test.puml
            echo "@enduml" >> test.puml
            echo "ğŸ“Š Test minimal avec test.puml..."
            java -jar plantuml.jar -v -tsvg test.puml
            mkdir -p docs
            cp test.svg docs/ || echo "âš ï¸ test.svg non gÃ©nÃ©rÃ©"
            ls -la docs/
          else
            echo "âœ… SVG gÃ©nÃ©rÃ©s correctement"
          fi

      - name: âœ… Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          publish_branch: gh-pages

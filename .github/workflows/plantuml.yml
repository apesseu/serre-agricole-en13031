name: PlantUML Diagram Generation

on:
  push:
    branches:
      - test-plantuml
      - main  # ajoute d'autres branches si besoin

jobs:
  generate-diagrams:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Download PlantUML (m√©thode fiable)
        run: |
          curl -L -o plantuml.jar "https://github.com/plantuml/plantuml/releases/latest/download/plantuml.jar"
          if [ ! -f plantuml.jar ] || [ ! -s plantuml.jar ]; then
            echo "‚ùå √âchec du t√©l√©chargement de PlantUML"
            exit 1
          fi
          echo "‚úÖ PlantUML t√©l√©charg√©: $(ls -lh plantuml.jar)"

      - name: Verify PlantUML installation
        run: java -jar plantuml.jar -version

      - name: Check PlantUML files
        run: |
          echo "Fichiers .puml trouv√©s:"
          find diagrams -name "*.puml" -type f || echo "Aucun fichier .puml trouv√©"

      - name: Generate SVG diagrams
        run: |
          mkdir -p docs
          puml_files=$(find diagrams -name "*.puml" -type f | wc -l)
          if [ "$puml_files" -eq 0 ]; then
            echo "‚ùå Aucun fichier .puml trouv√© dans diagrams/"
            exit 1
          fi
          echo "üìä G√©n√©ration des diagrammes..."
          success_count=0
          error_count=0
          for file in diagrams/*.puml; do
            if [ -f "$file" ]; then
              echo "üîÑ G√©n√©ration de: $file"
              if java -jar plantuml.jar -tsvg -v "$file" -o "../docs/"; then
                echo "‚úÖ Succ√®s: $file"
                ((success_count++))
              else
                echo "‚ùå Erreur lors de la g√©n√©ration de: $file"
                ((error_count++))
              fi
            fi
          done
          echo "üìà R√©sultats: $success_count succ√®s, $error_count erreurs"

      - name: List generated files
        run: |
          echo "Fichiers g√©n√©r√©s dans docs/:"
          ls -la docs/ || echo "Le dossier docs/ est vide"
          svg_count=$(find docs -name "*.svg" | wc -l)
          echo "Nombre de fichiers SVG: $svg_count"

      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          publish_branch: gh-pages
